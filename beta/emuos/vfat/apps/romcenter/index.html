<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>RomFixer</title>
		<link rel="stylesheet" type="text/css" href="css/tree.css" media="screen">
		<link rel="stylesheet" type="text/css" href="css/main.css" media="screen">
	</head>
	<body>
		<ul class="tree theme-classic">
			<a class="tree-label" href="javascript:">Title</a>
			<li class="tree-leaf tree-has-children">
				<a class="tree-leaf-label" href="javascript:">Label A</a>
				<input type="checkbox" />
				<span class="tree-toggle"></span>
				<ul class="tree-subtree">
					<li class="tree-leaf tree-has-children">
						<a class="tree-leaf-label" href="javascript:">Label A.A</a>
						<input type="checkbox" />
						<span class="tree-toggle"></span>
						<ul class="tree-subtree">
							<li class="tree-leaf">
								<a class="tree-leaf-label" href="javascript:">Label A.A.A</a>
							</li>
							<li class="tree-leaf">
								<a class="tree-leaf-label" href="javascript:">Label A.A.B</a>
							</li>
						</ul>
					</li>
					<li class="tree-leaf">
						<a class="tree-leaf-label" href="javascript:">Label A.A.A</a>
					</li>
					<li class="tree-leaf">
						<a class="tree-leaf-label" href="javascript:">Label A.A.B</a>
					</li>
					<li class="tree-leaf tree-has-children">
						<a class="tree-leaf-label" href="javascript:">Label A.A</a>
						<input type="checkbox" />
						<span class="tree-toggle"></span>
						<ul class="tree-subtree">
							<li class="tree-leaf">
								<a class="tree-leaf-label" href="javascript:">Label A.A.A</a>
							</li>
							<li class="tree-leaf">
								<a class="tree-leaf-label" href="javascript:">Label A.A.B</a>
							</li>
						</ul>
					</li>
				</ul>
			</li>
			<li class="tree-leaf tree-has-children">
				<a class="tree-leaf-label" href="javascript:">Label B</a>
				<input type="checkbox" />
				<span class="tree-toggle"></span>
				<ul class="tree-subtree">
					<li class="tree-leaf">
						<a class="tree-leaf-label" href="javascript:">Label B.A</a>
					</li>
				</ul>
			</li>
		</ul>

		<ol class="vtree">
			<li>
				<label for="folder1">Folder 1</label>
				<input type="checkbox" id="folder1" />
				<ol>
					<li>
						<label for="subfolder1">Subfolder 1</label>
						<input type="checkbox" id="subfolder1" />
						<ol>
							<li class="file"><a href="javascript:">File 1</a></li>
							<li>
								<label for="subsubfolder1">Subfolder 1</label>
								<input type="checkbox" id="subsubfolder1" />
								<ol>
									<li class="file"><a href="javascript:">File 1</a></li>
									<li>
										<label for="subsubfolder2">Subfolder 1</label>
										<input type="checkbox" id="subsubfolder2" />
										<ol>
											<li class="file"><a href="javascript:">Subfile 1</a></li>
											<li class="file"><a href="javascript:">Subfile 2</a></li>
											<li class="file"><a href="javascript:">Subfile 3</a></li>
											<li class="file"><a href="javascript:">Subfile 4</a></li>
											<li class="file"><a href="javascript:">Subfile 5</a></li>
											<li class="file"><a href="javascript:">Subfile 6</a></li>
										</ol>
									</li>
								</ol>
							</li>
							<li class="file"><a href="javascript:">File 3</a></li>
							<li class="file"><a href="javascript:">File 4</a></li>
							<li class="file"><a href="javascript:">File 5</a></li>
							<li class="file"><a href="javascript:">File 6</a></li>
						</ol>
					</li>
					<li class="file"><a href="javascript:">File 1</a></li>
				</ol>
			</li>
			<li>
				<label for="folder2">Folder 2</label>
				<input type="checkbox" id="folder2" />
				<ol>
					<li class="file"><a href="javascript:">File 1</a></li>
					<li>
						<label for="subfolder2">Subfolder 1</label>
						<input type="checkbox" id="subfolder2" />
						<ol>
							<li class="file"><a href="javascript:">Subfile 1</a></li>
							<li class="file"><a href="javascript:">Subfile 2</a></li>
							<li class="file"><a href="javascript:">Subfile 3</a></li>
							<li class="file"><a href="javascript:">Subfile 4</a></li>
							<li class="file"><a href="javascript:">Subfile 5</a></li>
							<li class="file"><a href="javascript:">Subfile 6</a></li>
						</ol>
					</li>
				</ol>
			</li>
			<li>
				<label for="folder3">Folder 3</label>
				<input type="checkbox" id="folder3" />
				<ol>
					<li class="file"><a href="javascript:">File 1</a></li>
					<li>
						<label for="subfolder3">Subfolder 1</label>
						<input type="checkbox" id="subfolder3" />
						<ol>
							<li class="file"><a href="javascript:">Subfile 1</a></li>
							<li class="file"><a href="javascript:">Subfile 2</a></li>
							<li class="file"><a href="javascript:">Subfile 3</a></li>
							<li class="file"><a href="javascript:">Subfile 4</a></li>
							<li class="file"><a href="javascript:">Subfile 5</a></li>
							<li class="file"><a href="javascript:">Subfile 6</a></li>
						</ol>
					</li>
				</ol>
			</li>
			<li>
				<label for="folder4">Folder 4</label>
				<input type="checkbox" id="folder4" />
				<ol>
					<li class="file"><a href="javascript:">File 1</a></li>
					<li>
						<label for="subfolder4">Subfolder 1</label>
						<input type="checkbox" id="subfolder4" />
						<ol>
							<li class="file"><a href="javascript:">Subfile 1</a></li>
							<li class="file"><a href="javascript:">Subfile 2</a></li>
							<li class="file"><a href="javascript:">Subfile 3</a></li>
							<li class="file"><a href="javascript:">Subfile 4</a></li>
							<li class="file"><a href="javascript:">Subfile 5</a></li>
							<li class="file"><a href="javascript:">Subfile 6</a></li>
						</ol>
					</li>
				</ol>
			</li>
			<li>
				<label for="folder5">Folder 5</label>
				<input type="checkbox" id="folder5" />
				<ol>
					<li class="file"><a href="javascript:">File 1</a></li>
					<li>
						<label for="subfolder5">Subfolder 1</label>
						<input type="checkbox" id="subfolder5" />
						<ol>
							<li class="file"><a href="javascript:">Subfile 1</a></li>
							<li class="file"><a href="javascript:">Subfile 2</a></li>
							<li class="file"><a href="javascript:">Subfile 3</a></li>
							<li class="file"><a href="javascript:">Subfile 4</a></li>
							<li class="file"><a href="javascript:">Subfile 5</a></li>
							<li class="file"><a href="javascript:">Subfile 6</a></li>
						</ol>
					</li>
				</ol>
			</li>
		</ol>

		<div class="content">
			<input id="file-input" name="roms" type="file" multiple="multiple" webkitdirectory="webkitdirectory" accept="application/zip, application/x-zip-compressed, application/x-7z-compressed, application/octet-stream" />
			<label for="creation-method-input"></label>
			<select id="creation-method-input" title="">
				<option value="Blob">RAM</option>
				<option value="File">HDD</option>
			</select>
			<div id="file-list"></div>
		</div>
		<script type="text/javascript" src="js/library/jquery-3.0.0-beta1.min.js"></script>
		<script type="text/javascript" src="js/library/zipjs/zip.js"></script>
		<script type="text/javascript">
			// noinspection JSUnresolvedFunction
			$(function() {
				// noinspection JSUnresolvedFunction
				var $filelist = $('#file-list');
				// noinspection JSUnresolvedFunction,JSUnusedLocalSymbols
				var $fileinput = $('#file-input');

				(function(obj) {

					zip.workerScriptsPath = 'js/library/zipjs/';
					zip.useWebWorkers = false;

					// noinspection JSUnresolvedVariable
					var requestFileSystem = obj.webkitRequestFileSystem || obj.mozRequestFileSystem || obj.requestFileSystem;

					function onerror(message) {
						alert(message);
					}

					function createTempFile(callback) {
						var tmpFilename = "tmp.dat";
						// noinspection JSUnresolvedVariable
						requestFileSystem(TEMPORARY, 4 * 1024 * 1024 * 1024, function(filesystem) {
							function create() {
								// noinspection JSUnresolvedFunction
								filesystem.root.getFile(tmpFilename, {
									create : true
								}, function(zipFile) {
									callback(zipFile);
								});
							}

							// noinspection JSUnresolvedFunction
							filesystem.root.getFile(tmpFilename, null, function(entry) {
								entry.remove(create, create);
							}, create);
						});
					}

					var model = (function() {
						// noinspection JSUnresolvedVariable
						var URL = obj.webkitURL || obj.mozURL || obj.URL;

						return {
							getEntries : function(file, onend) {
								zip.createReader(new zip.BlobReader(file), function(zipReader) {
									zipReader.getEntries(onend);
								}, onerror);
							},
							getEntryFile : function(entry, creationMethod, onend, onprogress) {
								var writer, zipFileEntry;

								function getData() {
									entry.getData(writer, function(blob) {
										// noinspection JSUnresolvedFunction
										var blobURL = creationMethod === "Blob" ? URL.createObjectURL(blob) : zipFileEntry.toURL();
										onend(blobURL);
									}, onprogress);
								}

								if (creationMethod === "Blob") {
									writer = new zip.BlobWriter();
									getData();
								} else {
									createTempFile(function(fileEntry) {
										zipFileEntry = fileEntry;
										writer = new zip.FileWriter(zipFileEntry);
										getData();
									});
								}
							}
						};
					})();

					(function() {
						var fileInput = document.getElementById("file-input");
						var unzipProgress = document.createElement("progress");
						var creationMethodInput = document.getElementById("creation-method-input");

						// noinspection JSUnusedLocalSymbols
						function download(entry, li, a) {
							model.getEntryFile(entry, creationMethodInput.value, function(blobURL) {
								var clickEvent = document.createEvent("MouseEvent");
								if (unzipProgress.parentNode)
									unzipProgress.parentNode.removeChild(unzipProgress);
								unzipProgress.value = 0;
								unzipProgress.max = 0;
								clickEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
								a.href = blobURL;
								a.download = entry.filename;
								a.dispatchEvent(clickEvent);
							}, function(current, total) {
								unzipProgress.value = current;
								unzipProgress.max = total;
								li.appendChild(unzipProgress);
							});
						}

						if (typeof requestFileSystem == "undefined") {
							creationMethodInput.options.length = 1;
						}


						fileInput.addEventListener('change', function() {
							$filelist.html('');

							var files = [];

							for (var i = 0; i < fileInput.files.length; i++) {
								files[fileInput.files[i].name] = {
									index: i,
									file: fileInput.files[i]
								};

								// noinspection JSUnresolvedFunction
								$filelist.append($('<h4>', {
									id: 'title' + i,
									text : fileInput.files[i].name + ' (' + fileInput.files[i].size + ' bytes)'
								}));

								// noinspection JSUnresolvedFunction
								$filelist.append( $('<ul>', {
									id: 'file' + i
								}));
							}

							for (var file in files) {
								var dateBefore = new Date();

								zip.createReader(new zip.BlobReader(files[file].file), function(zipReader) {
									zipReader.getEntries(function(entries) {
										var dateAfter = new Date();

										// noinspection JSUnresolvedFunction,JSReferencingMutableVariableFromClosure
										$('h4#title' + files[file].index).append($('<span>', {
											text: ' (loaded in ' + (dateAfter - dateBefore) + 'ms)'
										}));

										entries.forEach(function(entry) {
											// noinspection JSUnresolvedFunction
											$('ul#file' + files[file].index).append($('<li>', {
												text : entry.filename
											}));
										});
									});
								}, onerror);
							}
					}, false);
				})();
			})(this);
		});
		</script>
	</body>
</html>